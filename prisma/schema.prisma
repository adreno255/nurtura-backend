// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider     = "prisma-client-js"
    output       = "../src/generated/prisma"
    moduleFormat = "cjs"
}
datasource db {
    provider = "postgresql"
}


// ============================================
// ENUMS
// ============================================

enum PlantType {
    LEAFY_GREENS      // Lettuce (ASTERACEAE)
    TROPICAL_GREENS   // Malabar spinach (BASELLACEAE)
    HERBS             // Basil, Oregano, Rosemary (LAMIACEAE)
    ROOT_AND_STALK    // Cilantro, Celery, Parsley (APIACEAE)

    @@map("plant_type")
}

enum SoilType {
    LOAMY
    SANDY
    PEATY
    SILTY
    CHALKY
    CLAY

    @@map("soil_type")
}

enum ActivityEventType {
    RACK_ADDED
    RACK_REMOVED
    PLANT_CHANGED
    PLANT_HARVESTED
    LIGHT_ON
    LIGHT_OFF
    WATERING_ON
    WATERING_OFF
    AUTOMATION_TRIGGERED
    DEVICE_ONLINE
    DEVICE_OFFLINE

    @@map("activity_event_type")
}

enum NotificationType {
    SYSTEM
    ALERT
    WARNING
    INFO
    SUCCESS

    @@map("notification_type")
}

enum NotificationStatus {
    UNREAD
    READ
    ARCHIVED

    @@map("notification_status")
}

enum DeviceStatus {
    ONLINE
    OFFLINE
    ERROR
    MAINTENANCE

    @@map("device_status")
}


// ============================================
// MODELS
// ============================================

model User {
    // Primary fields
    id          String @id @default(cuid())
    firebaseUid String @unique @map("firebase_uid") @db.VarChar(128)
    email       String @unique @db.VarChar(255)

    // Personal information
    firstName  String  @map("first_name") @db.VarChar(100)
    middleName String? @map("middle_name") @db.VarChar(100)
    lastName   String  @map("last_name") @db.VarChar(100)
    suffix     String? @db.VarChar(20)
    address    String  @db.VarChar(500)

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    racks         Rack[]
    notifications Notification[]

    @@index([firebaseUid])
    @@index([email])
    @@map("users")
}

model Plant {
    // Primary fields
    id String @id @default(cuid())

    // Plant information
    name            String     @db.VarChar(200)
    type            PlantType?
    recommendedSoil SoilType?  @map("recommended_soil")
    description     String?    @db.VarChar(1000)

    // Status
    isActive Boolean @default(true) @map("is_active")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    racks           Rack[]
    automationRules AutomationRule[]
    rackHistory     RackPlantHistory[]

    @@map("plants")
}

model Rack {
    // Primary fields
    id     String @id @default(cuid())
    userId String @map("user_id")

    // Device information
    name        String  @db.VarChar(200)
    macAddress  String  @unique @map("mac_address") @db.VarChar(17)
    mqttTopic   String? @map("mqtt_topic") @db.VarChar(255)
    description String? @db.VarChar(1000)

    // Current plant in this rack (ONE plant per rack)
    currentPlantId  String?   @map("current_plant_id")
    quantity        Int       @default(0)
    plantedAt       DateTime? @map("planted_at")
    expectedHarvest DateTime? @map("expected_harvest")
    lastHarvestAt   DateTime? @map("last_harvest_at")
    harvestCount    Int       @default(0) @map("harvest_count")

    // Status fields
    isActive       Boolean      @default(true) @map("is_active")
    status         DeviceStatus @default(OFFLINE)
    lastActivityAt DateTime?    @map("last_activity_at")
    lastSeenAt     DateTime?    @map("last_seen_at")
    lastWateredAt  DateTime?    @map("last_watered_at")
    lastLightOnAt  DateTime?    @map("last_light_on_at")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    user               User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
    currentPlant       Plant?                    @relation(fields: [currentPlantId], references: [id], onDelete: SetNull)
    activities         Activity[]
    notifications      Notification[]
    sensorReadings     SensorReading[]
    aggregatedReadings AggregatedSensorReading[]
    rackHistory        RackPlantHistory[]

    @@index([userId])
    @@index([macAddress])
    @@index([status])
    @@index([lastSeenAt])
    @@index([currentPlantId])
    @@map("racks")
}

model RackPlantHistory {
    // Primary fields
    id      String @id @default(cuid())
    rackId  String @map("rack_id")
    plantId String @map("plant_id")

    // Historical tracking
    quantity     Int
    plantedAt    DateTime  @map("planted_at")
    harvestedAt  DateTime? @map("harvested_at")
    harvestCount Int       @default(0) @map("harvest_count")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    rack  Rack  @relation(fields: [rackId], references: [id], onDelete: Cascade)
    plant Plant @relation(fields: [plantId], references: [id], onDelete: Cascade)

    @@index([rackId])
    @@index([plantId])
    @@index([plantedAt])
    @@map("rack_plant_history")
}

model SensorReading {
    // Primary fields
    id     String @id @default(cuid())
    rackId String @map("rack_id")

    // Sensor data
    temperature Float  // Celsius
    humidity    Float  // Percentage (0-100)
    moisture    Float  // Percentage (0-100)
    lightLevel  Float  @map("light_level") // Lux or raw LDR value
    waterUsed   Float? @map("water_used") // mL

    // Metadata
    timestamp DateTime @default(now())
    rawData   Json?    @map("raw_data")

    // Relations
    rack Rack @relation(fields: [rackId], references: [id], onDelete: Cascade)

    @@index([rackId, timestamp])
    @@index([timestamp])
    @@index([rackId])
    @@map("sensor_readings")
    }

model AggregatedSensorReading {
    // Primary fields
    id     String   @id @default(cuid())
    rackId String   @map("rack_id")

    hour   DateTime
    // Average values
    avgTemperature Float @map("avg_temperature")
    avgHumidity    Float @map("avg_humidity")
    avgMoisture    Float @map("avg_moisture")
    avgLightLevel  Float @map("avg_light_level")

    // Min/Max values
    minTemperature Float @map("min_temperature")
    maxTemperature Float @map("max_temperature")
    minMoisture    Float @map("min_moisture")
    maxMoisture    Float @map("max_moisture")

    // Metadata
    readingCount Int      @map("reading_count")
    createdAt    DateTime @default(now()) @map("created_at")

    // Relations
    rack Rack @relation(fields: [rackId], references: [id], onDelete: Cascade)

    @@unique([rackId, hour])
    @@index([rackId, hour])
    @@index([hour])
    @@map("aggregated_sensor_readings")
}

model AutomationRule {
    // Primary fields
    id      String @id @default(cuid())
    plantId String @map("plant_id")

    // Rule information
    name        String  @db.VarChar(200)
    description String? @db.VarChar(1000)
    isEnabled   Boolean @default(true) @map("is_enabled")

    // Rule configuration (JSON)
    conditions Json
    actions    Json
    
    // Execution tracking
    cooldownMinutes Int? @map("cooldown_minutes")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    plant Plant @relation(fields: [plantId], references: [id], onDelete: Cascade)

    @@index([plantId])
    @@index([isEnabled])
    @@map("automation_rules")
}

model Activity {
    // Primary fields
    id     String @id @default(cuid())
    rackId String @map("rack_id")

    // Activity information
    eventType ActivityEventType @map("event_type")
    details   String?           @db.VarChar(1000)
    metadata  Json?
    timestamp DateTime          @default(now())

    // Relations
    rack Rack @relation(fields: [rackId], references: [id], onDelete: Cascade)

    @@index([rackId])
    @@index([timestamp])
    @@index([eventType])
    @@index([rackId, timestamp])
    @@map("activities")
}

model Notification {
    // Primary fields
    id     String  @id @default(cuid())
    userId String  @map("user_id")
    rackId String? @map("rack_id")

    // Notification information
    type     NotificationType   @default(INFO)
    status   NotificationStatus @default(UNREAD)
    title    String             @db.VarChar(255)
    message  String             @db.VarChar(1000)
    metadata Json?

    // Tracking
    readAt DateTime? @map("read_at")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
    rack Rack? @relation(fields: [rackId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([status])
    @@index([createdAt])
    @@index([userId, status])
    @@map("notifications")
}