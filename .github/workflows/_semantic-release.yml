name: Semantic Release

on:
    workflow_call:
        outputs:
            new-release-published:
                description: 'Whether a new release was published'
                value: ${{ jobs.release.outputs.new-release-published }}
            new-release-version:
                description: 'The new release version'
                value: ${{ jobs.release.outputs.new-release-version }}

jobs:
    release:
        runs-on: ubuntu-latest
        outputs:
            new-release-published: ${{ steps.semantic.outputs.new-release-published }}
            new-release-version: ${{ steps.semantic.outputs.new-release-version }}

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: false

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '25'
                  cache: 'npm'

            - name: Install semantic-release
              run: |
                  npm install --no-save \
                  semantic-release \
                  @semantic-release/commit-analyzer \
                  @semantic-release/release-notes-generator \
                  @semantic-release/changelog \
                  @semantic-release/git \
                  @semantic-release/github \
                  @semantic-release/npm

            - name: Run semantic-release
              id: semantic
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  npx semantic-release > release.log 2>&1 || true

                  if grep -qE "(Published release|Release published)" release.log; then
                      VERSION=$(grep -oE "v?[0-9]+\.[0-9]+\.[0-9]+" release.log | head -n 1)
                      
                      VERSION=${VERSION#v}
                    
                      if [ -n "$VERSION" ]; then
                        echo "new-release-published=true" >> $GITHUB_OUTPUT
                        echo "new-release-version=$VERSION" >> $GITHUB_OUTPUT
                        echo "Release published: $VERSION"
                      else
                        echo "new-release-published=false" >> $GITHUB_OUTPUT
                        echo "Version extraction failed, but release may have succeeded"
                      fi
                  else
                    echo "new-release-published=false" >> $GITHUB_OUTPUT
                    echo "No new release published"
                  fi

                  echo "=== Release Log ==="
                  cat release.log

            - name: Log release info
              if: steps.semantic.outputs.new-release-published == 'true'
              run: |
                  echo "New release published!"
                  echo "Version: ${{ steps.semantic.outputs.new-release-version }}"
                  echo "Major: ${{ steps.semantic.outputs.new-release-major-version }}"
                  echo "Minor: ${{ steps.semantic.outputs.new-release-minor-version }}"
                  echo "Patch: ${{ steps.semantic.outputs.new-release-patch-version }}"
