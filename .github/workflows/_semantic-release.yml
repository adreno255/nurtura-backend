name: Semantic Release

on:
    workflow_call:
        secrets:
            RELEASE_STEP_TOKEN:
                description: 'PAT with bypass permission to push directly to main'
                required: true
        outputs:
            new-release-published:
                description: 'Whether a new release was published'
                value: ${{ jobs.release.outputs.new-release-published }}
            new-release-version:
                description: 'The new release version'
                value: ${{ jobs.release.outputs.new-release-version }}

jobs:
    release:
        runs-on: ubuntu-latest
        outputs:
            new-release-published: ${{ steps.semantic.outputs.new-release-published }}
            new-release-version: ${{ steps.semantic.outputs.new-release-version }}

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: true
                  token: ${{ secrets.RELEASE_STEP_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '25'
                  cache: 'npm'

            - name: Install semantic-release
              run: |
                  npm install --no-save \
                  semantic-release \
                  @semantic-release/commit-analyzer \
                  @semantic-release/release-notes-generator \
                  @semantic-release/changelog \
                  @semantic-release/git \
                  @semantic-release/github \
                  @semantic-release/npm \
                  conventional-changelog-conventionalcommits

            - name: Run semantic-release
              id: semantic
              env: # uses PAT token in GitHub
                  GITHUB_TOKEN: ${{ secrets.RELEASE_STEP_TOKEN }}
                  GIT_AUTHOR_NAME: github-actions[bot]
                  GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
                  GIT_COMMITTER_NAME: github-actions[bot]
                  GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
              run: |
                  npx semantic-release > release.log 2>&1 || true

                  if grep -qE "(Published release|Release published)" release.log; then
                      VERSION=$(grep -E "Published release|Release published" release.log \
                        | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" \
                        | head -n 1)

                      if [ -n "$VERSION" ]; then
                          echo "new-release-published=true" >> $GITHUB_OUTPUT
                          echo "new-release-version=$VERSION" >> $GITHUB_OUTPUT
                          echo "Release published: $VERSION"
                      else
                          echo "new-release-published=false" >> $GITHUB_OUTPUT
                          echo "::warning::Release log matched but version could not be extracted"
                      fi
                  else
                      echo "new-release-published=false" >> $GITHUB_OUTPUT
                      echo "No new release published"
                  fi

                  echo "=== Release Log ==="
                  cat release.log

            - name: Log release info
              if: steps.semantic.outputs.new-release-published == 'true'
              run: |
                  echo "New release published!"
                  echo "Version: ${{ steps.semantic.outputs.new-release-version }}"
